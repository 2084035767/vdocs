# 第四章：文件系统

## 4.1 文件系统的概念和组织



### 文件应该有哪些属性

文件名属，甚至说是最重要的一个属性，‍‍

第二个重要的属性是标识服务，操作系统会在背后为各个文件设置一个标识符，‍‍每个文件的标识符都是唯一的，只是操作系统用于区分各个文件的一种内部的名称。‍‍

第三，每个文件会有一个叫做文件类型的属性，‍‍所以文件类型也是一个很重要的属性。‍‍

第四个很重要的属性是文件的位置，

很重要的属性就是文件的保护信息，‍‍只不过文件的保护信息这个属性，

### 文件内部数据的组织



无结构文件

无结构文件它就是由一系列二进制或者说字符流组成，它没有明显的结构特性

有结构文件

它是由一个一个的记录组成，每一个记录又由一系列的数据项组成，‍‍这些记录应该如何组织的问题。‍‍也就是这些记录它们之间应该是顺序的存放，还是用一个索引表来表示它们之间的这种先后顺序



### 文件之间的被组织



### 文件相关的系统调用



操作系统还需要提供打开文件和关闭文件这两个基本的功能。‍‍

> 在使用一个文件之前，也就是读写文件之前，一定需要先使用操作系统的open系统调用，‍‍也就是打开文件的功能，而当一个文件使用结束之后，需要使用close系统调用来关闭文件。‍‍





### 文件在外存的存放





类似于内存，外存也会被分为一个大小相等的块，‍‍或者叫磁盘块物理块，每一个磁盘块的大小都是相等的，‍‍并且每个磁盘块一般会包含二的整数幂个地址

相应的文件的逻辑地址也可以分为逻辑块号和块内地址这样的两个部分。‍‍操作系统同样也需要把文件的逻辑地址转换成外存的物理地址，也就是物理块号和块内地址这样的形式。‍‍



### 文件的逻辑结构

‍





### 无结构文件



‍

‍

### 有结构文件的逻辑结构

为顺序文件、索引文件和索引顺序文件



‍

### 顺序文件

顺序文件结构的话，‍‍那么文件中的这些记录会一个接一个的顺序的排列，这些记录可以是定长的，也可以是可变长的，‍‍并且各个记录在物理上可以是顺序存储，也可以是链式存储。‍‍如果说这些记录是顺序存储的话，‍‍那么在逻辑上相邻的这些记录，在物理上也是相邻的，‍‍这就类似于咱们之前提到的顺序表那种数据结构，而如果说采用的是链式存储这种物理结构的话，‍‍那么逻辑上相邻的这些记录在物理上不一定相邻，就类似于咱们之前的链表，‍‍

‍

根据这个记录是否按照关键字的顺序来排列，又可以把顺序文件分为

串结构

串结构就是指记录之间的顺序与关键字无关，如果是串结构的话，那么‍‍记录之间的顺序一般来说是按照存入的时间先后顺序来决定的

顺序结构，

顺序结构的话，‍‍就必须保证记录之间的先后顺序是按照关键字的顺序来排列的，显然‍‍记录到底是定长的还是可变长的，这些记录是否按照关键字有序的排列，另外‍‍这些记录在物理上到底是顺序存储还是链式存储，‍‍

‍

‍

### 索引文件

每一个文件会建立一张索引表，并且每一个索引表的表项会对应这个文件的一条记录，‍‍文件的这些记录在物理上不需要连续存放，‍‍但是索引表的各个表项在物理上是需要连续存放的。‍‍另外‍‍每一个索引表的表项的大小都是相等的，比如说索引号，长度，‍‍指针，这3个字段分别占4个字节，那么1个索引表的表项总共就需要占12个字节的长度，‍‍因此索引表本身也可以理解成是一种定长记录的顺序文件。‍‍





### 索引顺序文件

索引顺序文件。它是一种索引文件和顺序文件思想的结合，‍‍与索引文件类似的是索引顺序文件当中同样会为一个文件建立一张索引表，‍‍但是与索引文件不同的是索引顺序文件当中并不会为每一个记录‍‍建立一个对应的索引表项，而是会给这些记录进行分组，然后每一个分组对应一个索引表项，‍‍



### 文件目录

### 文件控制块

‍

文件控制块，

因此我们在这个地方看到的目录，其实它也是一种特殊的文件，



‍

它就是一个文件控制块，英文缩写是FCB，‍‍所以其实这些FCB的有序结合就是所谓的文件目录，而一个FCB就是一个文件目录项，‍‍那很显然每一个文件都会对应一个FCB。‍‍



另外从这个例子中，我们可以看到FCB中包含了有文件的一些基本信息，‍‍包括文件名、物理地址，还有文件的逻辑结构、物理结构等等一系列的基本信息。‍‍另外还会有文件存取权限、存取控制相关的一些信息，包括文件是否可读，是否可写等等。‍‍除了这些之外，还会有文件的一些使用信息，包括文件是在什么时候建立的，上一次修改的时间是多少等等。‍‍不过所有的这些信息当中最重要的还是文件名，‍‍还有文件的存放的物理地址这两个信息，



‍

### 单级目录结构

早期的操作系统，它只会在整个系统当中建立一张目录表，每个文件会占用一个目录表的目录项，‍‍这种单极目录结构是支持按名存取的，因为这个 FCB当中其实也是包含文件名这个‍‍关键字。‍‍但是单级目录最大的一个缺点就是不允许文件重名，‍‍



‍

### 两级目录结构

在这种目录结构当中会把目录分为两级，第一集叫做主文件目录，英文缩写是MFD和‍‍用户的文件目录，英文缩写是UFD

主文件目录就是记录了用户名，还有用户名对应的用户文件目录存放的位置。‍‍而一个用户文件目录又由这个用户的那些文件对应的FCB组成。‍‍由于不同的用户文件是存放在不同的用户文件目录下的，所以在这种情况下，‍‍不同用户的文件是允许重名的，不过虽然它们的文件名是相同的，但是它们实际对应的文件数据是不同的两个数据。‍‍



### 多级目录结构



叫树形目录结构，这也是现代操作系统当中很常用的一种目录结构，‍‍每一个目录下面可以有更低一级的目录，同时在各个目录下面也可以有一些普通的文件，‍‍并且不同目录下的文件是可以重名的，和刚才一样不同目录下的文件虽然说名字是相同的，‍‍但是他们实际对应的文件并不是同一个，‍

‍

不过树形目录结构也并不是万能的，它可以很方便的对文件进行分类，层次结构清晰，‍‍也可以很方便的对文件进行管理和保护，但是树形结构不便于实现文件的共享，这个知识点也是经常在选择题当中进行考察的。‍‍为了解决这个问题，人们又提出了无环图目录结构

‍

### 无环图目录结构

其实无环图目录结构和树形目录结构也比较相似，只不过是在‍‍树形目录结构的基础上，增加了这样的一些指向同一个节点的有向边，‍‍使整个目录的结构看起来是成为了一个有向无环图，‍‍有向无环图相关的知识点，是在数据结构当中进行学习的，‍‍这样的话就很方便的可以实现多个用户间的文件共享。‍‍

‍

### 索引节点（FCB的改进）

这其实是对FCB这种数据结构的一种改进，‍‍由一系列的FCB，也就是文件控制块，组成了一个一个的文件目录，‍‍但是其实操作系统在查找各级目录的过程当中，只需要使用文件名这个信息就可以了，而其他的这些‍‍而冗余的信息暂时不需要，只有文件名匹配的时候，才需要去关心这个文件存放的物理位置，‍‍

### 文件的物理结构

### 文件块、磁盘块

### 文件分配方式--连续分配

连续分配方式的思想很简单，要求每个文件在磁盘上占用一组连续的块，‍‍如果说采用连续分配方式的话，这些逻辑上相邻的块在物理上‍‍也必须相邻，也必须是占用一组连续的块，并且依然需要保持这些块之间的这种相对顺序。‍‍





### 链接分配

链接分配采取的是离散分配的这种思想，可以为文件分配离散的磁盘块，‍‍然后用指针链接的方式，它们把这些磁盘块都给串联起来，‍‍而链接分配方式又可以进一步分为隐式链接和显示链接两种，

#### ‍隐式链接

如果采用的是链接分配--隐式链接的这种方式的话，那么这种文件它只支持顺序访问，‍‍不支持随机访问。‍‍



#### 显示链接

显示链接的链接分配方式，这种方式会把‍‍用于链接文件各个物理块的指针显示的存放在一张表当中，这个表就被称为文件分配表，‍‍英文缩写是FAT，

‍

### 多级索引

要建立多层的索引表，‍‍使第一层索引块指向第二层索引块，如果说文件很大的话，甚至还可以建立第三层第四层索引块





### 混合索引

混合索引它是多种索引分配方式的一种结合，比如说一个文件的顶级索引表当中，‍‍它可能会包含一些直接地址索引，比如说8个直接地址索引，所谓的直接地址索引就是指‍‍这些索引项是直接指向了一个数据块，所以‍‍8个直接地址索引会对应8个数据块。‍‍



### 文件存储空间管理

‍

### 存储空间的划分与初始化



首先是要知道什么是文件卷或者叫逻辑卷逻辑盘，另外我们需要知道文件卷‍‍会划分成目录区和文件区，也还需要知道文件区和目录区分别是用于存放什么数据的。‍‍另外我们需要注意的是，文件卷是可以由多个物理磁盘组成的。‍‍



‍

### 空闲表法

空闲表和我们在内存管理的动态分区分配当中，学习过的空闲表是‍‍极其类似的，它就是记录了每一个空闲区间的起始位置，还有空闲区间的长度这两个信息。‍‍像

‍

‍

### 空闲链表法

空闲链表法又可以进一步划分为空闲盘块链和空闲盘区链，‍‍它们的区别在于空闲盘块链它是以盘块为单位，就组成一条空闲链，‍‍就像这个样子，每一个空闲的盘块中都会存储着指向下一个空闲盘块的指针，‍‍



### 空闲盘区链



‍

### 位示图法

位示图法，这也是咱们在考试当中最常考的一种方法，‍‍这种方法的原理其实也很简单，就是用一个的二进制位来分别对应各个盘块的‍‍是否已分配这样的一个信息，比如说在这个例子当中，我们用零代表一个盘块空闲，‍‍用一代表一个盘块不空闲已分配，‍‍



### 成组链接法

在UNIX系统当中采用的是成组连接法，对磁盘的空弦块进行分组的管理，‍‍

在文件卷等目录区当中会设置一个专门的磁盘块，把它作为所谓的超级块，‍‍当系统启动的时候需要把超级块读入内存，‍‍并且在整个过程当中需要保持内存和外存当中超级块的数据一致。‍‍







### 文件系统的层次结构



### 层次结构



## 4.2 文件的操作和访问控制

‍

### 创建文件

### 删除文件

### 打开文件

### 关闭文件

### 读文件

### 写文件

### 文件共享


那文件共享的实现方式有这样的两种，一种是基于索引节点的共享方式，‍‍又叫硬链接的方式，另一种是基于符号链的共享方式，又叫软链接的共享方式。‍‍



### 硬连接

它其实就是一种文件目录的瘦身策略。‍‍由于我们在根据路径检索文件的时候，只需要使用文件名，所以我们可以把除了文件名之外的其他信息都放到索引节点当中，‍‍这样的话目录项就可以变得更小，它只需要包含文件名，还有指向索引节点的一个指针就可以了。‍‍



‍

### 软链接

基于符号链的这种共享方式，又叫软链接的共享方式，其实这种link类型的文件就有点类似于windows操作系统当中的快捷方式。‍‍因此如果采用的是软链接的共享方式的话，‍‍并不是把自己的目录项直接指向文件的索引节点，‍‍而是创建了一个新的link型的文件，然后link型的文件当中记录了文件的存放路径，‍‍之后操作系统会根据这个路径来找到想要共享的文件。‍‍

‍

### 文件保护

### 口令保护

### 加密保护

### 访问控制

## 4.3 文件系统的实现

## 4.4 磁盘调度算法

### 一次磁盘的读/写操作需要的时间

- 寻道时间：首先我们在确定了我们想要读取的那些数据是存放在哪一个磁道上之后，‍‍就需要把磁头移动到指定的磁道上去，所以其实移动磁头的过程是需要花费一定的时间的。‍‍

- 第二个读写操作需要花费的时间叫延迟时间，延迟时间就是指要我们通过旋转磁盘，使磁头定位到目标上区所需要的‍‍时间。

- 第三个部分的时间叫传输时间，‍‍就是指从磁盘读出或者向磁盘写入数据所要经历的时间。

‍

### 先来先服务

根据进程请求‍‍访问磁盘的先后顺序来进行调度

### 最短寻找时间优先算法

优先处理此时与当前磁头离得最近的磁道，‍‍这样的话可以保证每一次寻到时间都是最短的，但是虽然每一次的寻到时间最短，‍‍不过总体上并不能保证总的寻道时间最短，这其实是和贪心算法一样的思想，‍‍只是选择眼前最优的，但是总体上未必最优。

‍

### 扫描算法

扫描算法规定只有磁头移动到最外侧磁道的时候才可以往内侧移动，‍‍只有移动到最内侧磁道的时候才可以开始往外侧移动。‍‍由于磁头移动的方式比较像我们平时乘坐的电梯，所以这个算法也可以称作为电梯算法，我们还是结合刚才的那个例子来进行分析。‍‍



### look调度算法

这个算法与扫描算法相比增加了这样的一种策略，就是‍‍如果在磁头移动方向上已经没有别的请求了，那么就可以立即改变磁头的移动方向。‍‍所以其实这个调度算法有点类似于是一边移动磁头一边观察前边还有没有别的请求，‍‍这样的一个过程，所以它叫look方法。‍‍





### C-SCAN 算法

也叫循环扫描算法，这种算法规定‍‍只有磁头朝某一个特定方向移动的时候，才会处理磁道的访问请求，‍‍而在磁头返回起点的这个过程中，会直接快速的移动到起始端的位置，‍‍而不进行任何的请求处理。‍‍

‍

### C-LOOK算法

C-LOOK算法和look算法其实是很类似的，也是采用了同样的思想，如果磁头移动的方向上已经没有任何磁道访问的请求了，那就可以立即让磁头返回，‍‍并且磁头只需要返回到有磁道访问请求的位置就可以了





## 4.5 文件系统的性能优化

### 磁盘地址结构的设计



### 减少磁盘延迟时间的方法

### 交替编号

可以采用交替编号的方式，也就是让逻辑上相邻的扇区在物理上有一定的间隔

‍

### 错位命名





### 磁盘的管理

‍

### 磁盘初始化



‍

### 引导块





### 磁盘的坏块



‍
