# T-SQL 基本语法 

==以 SQL Server 为主，MySql 以后会补充==

## T-SQL

T-SQL 即 Transact-SQL，是 SQL 在 Microsoft SQL Server 上的增强版，它是用来让应用程式与 SQL Server 沟通的主要语言。T-SQL 提供标准 SQL 的 DDL 和 DML 功能，加上延伸的函数、系统预存程序以及程式设计结构(例如 IF 和 WHILE)让程式设计更有弹性。

## 变量定义和使用

### 代码操作（SQL Server）

#### 局部变量

定义

```sql
--使用局部变量前必须用declare定义
--局部变量被引用前必须用@标志
--局部变量数据类型不能是text，ntext，image

declare @变量名 数据类型[,@变量名 数据类型]
```

赋值

```sql
--set只能为一个变量赋值，select可以多个
--表达式值可以是直接数据，也可从表中获取，若表中返回多值只能用select，且取最后值赋给变量
--表达式值应与定义数据类型一致

set @变量名 = 表达式值
select @变量名 = 表达式值[,@变量名 = 表达式值]
select @变量名 = 输出值 from 表名 where 条件
```

输出

```sql
select @变量名 --字段返回
print @变量名 --数据返回
```

#### 全局变量

1. 全局变量是由系统服务器定义的，用@@标识
2. 用户只可使用全局变量，不能对其重新定义和修改
3. 使用全局变量的一般格式：@@变量名
4. 局部变量的命名不能与全局变量相同

常用的系统全局变量

1. @@error ：返回最后一个语句产生的错误代码
2. @@荣威 count ：返回最后一个语句执行后受影响的行数，任何不返回行的语句将置该变量为零
3. @@trancount ：事务嵌套即计数
4. @@transtate ： 一个语句执行后事务的当前状态

```sql
--显示当前日期和时间为止用户试图登录系统的次数
select getdate() , @@connections
```

​                                                                                   

### 运算符和表达式

#### 数学表达式

| 运算 | 符号 |
| :--: | :--: |
| 加法 |  +   |
| 减法 |  -   |
| 乘法 |  *   |
| 除法 |  /   |
| 取余 |  %   |
| 取正 |  +   |
| 取反 |  -   |

#### 字符串表达式

字符串表达式常用于字符串运算和操作，用“+”表示字符串连接

#### 关系表达式

|   关系   |  符号  |
| :------: | :----: |
|   等于   |   =    |
|  不等于  | !=或<> |
|   大于   |   >    |
| 大于等于 |   >=   |
|   小于   |   <    |
| 小于等于 |   <=   |
|  不大于  |   !>   |
|  不小于  |   !<   |

#### 逻辑表达式

|      逻辑      | 符号 |
| :------------: | :--: |
|    全真为真    | and  |
|    全假为假    |  or  |
| 真变假，假变真 | not  |

#### 运算符优先级

==()优先级最高==

| 优先级 | 运算符名称   | 运算符                          |
| ------ | ------------ | ------------------------------- |
| 1      | 乘、除、求模 | *、/、%                         |
| 2      | 加减         | +、-                            |
| 3      | 比较         | =、!=、<>、!>、!<、<、>、>=、<= |
| 4      | 逻辑         | not                             |
| 5      | 逻辑         | and                             |
| 6      | 逻辑         | or                              |

### 流程控制语句

#### begin······end（通用）

begin……end 语句将多个 t-sql 语句组合成语句块，并将其视为一个单元

--类似 C 语言中的{ }

```sql
begin
sql 语句或语句块
·end
```

#### go（SQL Server）

- go 语句用于定义批处理的结束，是 t-sql 的结束语句。
- 两 go 之间的语句形成一个批处理
- 好处：可以将代码分成若干小段

#### print（SQL Server）

print 用于输出

1. 直接显示字符串

   ```sql
   print 字符串
   print 'hello'
   ```

2. 直接显示变量值

   ```sql
   print @变量名
   print @i
   ```

#### if（通用，语法不同）

if 为判断语句

代码操作

````sql
if (条件表达式)
sql 语句或语句块
[else if (条件表达式)]
sql 语句或语句块
[else]
sql 语句或语句块
````

- 条件表达式的括号可以省略，但遇见 select 必须要将 select 查询括起来
- SQL Server 控制语句中的 sql 语句或语句块有两个及以上应用 begin······end 语句

#### case（通用）

case 是多重条件判断语句，可以计算多个条件值，返回符合条件的结果。

1. 简单 case 语句

   将某表达式与一组简单的表达式比较以决定结果

   ```sql
   case 输入表达式
   when 条件表达式 then 结果表达式
   [,when 条件表达式 then 结果表达式]
   [else 结果表达式]
   end
   --都不符合，返回null
   ```

2. 搜索 case 语句

   计算一组布尔表达式以决定结果

   ```sql
   case
   when 布尔表达式 then 结果表达式
   [,when 布尔表达式 then 结果表达式]
   [else 结果表达式]
   end
   --都不符合，返回null
   ```

#### while（通用，语法不同）

while 语句用于条件为真时，重复执行 sql 语句或语句块。

代码操作

```sql
   while (条件表达式)
   	sql 语句或语句块
```

- 条件表达式的括号可以省略，但遇见 select 必须要将 select 查询括起来
- continue 可用于语句块跳过循环，回到 while 的第一行语句
- break 可用于语句块跳出循环，结束 while 的所有语句

#### if[not] exists（通用，语法不同）

if[not] exists 语句用于判断是否有数据存在，一般搭配 select 语句使用

代码操作

```sql
if[not] exists(select语句)
	sql 语句或语句块
[else]
	sql 语句或语句块
```

#### waitfor（SQL Server）

waitfor 语句用来暂停执行 t-sql 语句、语句块和存储过程等，直到所设定的时间已到才继续执行（在定义测试时特别有用）

语法格式

```sql
waitfor{delay 'time' | time 'time'}
```

- delay 用于指定时间间隔，表示延迟“time”时间后执行
- time 用于指定某一时刻，表示在“time”时刻执行
- “time”的数据类型为 datatime，格式为“hh:mm:ss”